# HDX Scraper - Insecurity Insight

First a virtual enviroment is created and activated

```shell
python -m venv venv_hdx_insecurity
source venv_hdx_insecurity/Scripts/activate
```

The code is installed with

```shell
pip install -e .
```

# Overview

The production of Excel spreadsheets from the Insecurity Insight API is driven by the `attributes.csv` and `schema.csv` files.
The `attributes.csv` file contains information like paths and URLs to the resource samples and the API and is generated manually.
The `schema.csv` can be generated automatically from a sample (using `generate_api_transformation_schema.py`) of the API response 
and a sample spreadsheet but then edited as any normal file, perhaps to add or update HXL tags.

Where API fields are not readily associated with the existing Exel spreadsheets the file `field_mappings.csv` provide a lookup.

Entries in both `attributes.csv` and `schema.csv` are keyed by a `dataset_name`

# Onboarding process
To onboard a new dataset the following attributes need to be added to `attributes.csv`:

| dataset name | timestamp | attribute | value | secondary_value |
| ----- | ------ | ----- | ----- | ----- |
| insecurity-insight-crsv-incidents | 2023-11-21T08:28:08.167022 | resource_filename | 2020-2023-conflict-related-sexual-violence-crsv-incident-data.xlsx | 
| insecurity-insight-crsv-incidents | 2023-11-21T08:28:08.167022 | api_url | https://sind-api.herokuapp.com/hdx/v1/sv | 
| insecurity-insight-crsv-incidents | 2023-11-21T08:28:08.167022 | api_response_filename | sv.json | 
| insecurity-insight-crsv-incidents | 2023-11-21T08:28:08.167022 | filename_template | {start_year}-{end_year}{country_iso}-conflict-related-sexual-violence-crsv-incident-data.xlsx |

The `generate_api_transformation_schema.py` is then run to generate entries in `schema.csv`: 

```
./generate_api_transformation_schema.py {dataset_name|all}
```


A spreadsheet can be generated by running `create_spreadsheets.py`:

```
./create_spreadsheets.py {dataset_name|all} {iso_country_code|}
```

Once spreadsheets have been created the `create_datasets.py` command is run to create the datasets in HDX. A commandline argument (the dataset name) can be supplied with the word "all" instructing the script to create all the datasets defined in the `attributes.csv` file, an (uppercase) ISO country code can be used as a second optional argument with the dataset name `insecurity-insight-country-dataset` to produce country pages.

```
./create_datasets.py {dataset_name|all} {iso_country_code|}
```

